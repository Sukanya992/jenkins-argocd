pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "sukanya996/agrocd:latest"
        GKE_CLUSTER_NAME = "my-cluster"
        GKE_PROJECT_ID = "plated-epigram-452709-h6"
        GKE_REGION = "us-central1"
        KUBECONFIG = "$WORKSPACE/kubeconfig.yaml"  // Path for Kubeconfig file
    }

    stages {
        stage('Checkout Code') {
            steps {
                git ''
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    sh 'docker build -t $DOCKER_IMAGE .'
                }
            }
        }

        stage('Push Docker Image to Docker Hub') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'dockerhub', passwordVariable: 'DOCKER_PASSWORD', usernameVariable: 'DOCKER_USERNAME')]) {
                        sh "docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD"
                        sh "docker push $DOCKER_IMAGE"
                    }
                }
            }
        }

        stage('Provision Kubernetes Cluster with Terraform') {
            steps {
                script {
                    sh 'terraform init'
                    sh 'terraform apply -auto-approve'
                }
            }
        }

        stage('Install Argo CD with Terraform') {
            steps {
                script {
                    sh 'terraform apply -auto-approve'
                }
            }
        }

        stage('Configure kubectl') {
            steps {
                script {
                    sh 'gcloud container clusters get-credentials $GKE_CLUSTER_NAME --region $GKE_REGION --project $GKE_PROJECT_ID'
                }
            }
        }
    }
}
